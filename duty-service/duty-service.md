# Duty Service — Сервис управления дежурствами

**Duty Service** обеспечивает полный цикл управления дежурствами студентов в кампусе, от назначения расписания до проверки фотоотчётов. Сервис интегрируется с auth-service для аутентификации и авторизации, а также использует MinIO для хранения фотографий.

База данных: `duty_db`

## Общие сведения

### Назначение сервиса

**Duty Service** — микросервис для управления дежурствами студентов в Кампусе Сириус. Обеспечивает:

- Создание и управление расписанием дежурств
- Приём и проверку фотоотчётов о выполнении дежурств
- Категоризацию помещений для фотоотчётов
- Уведомление студентов о предстоящих дежурствах

### Технические характеристики

| Параметр        | Значение                           |
| --------------- | ---------------------------------- |
| **Язык**        | Python 3.11+                       |
| **Фреймворк**   | FastAPI                            |
| **ORM**         | SQLAlchemy 2.0+ (async)            |
| **БД**          | PostgreSQL 15+                     |
| **Хранилище**   | MinIO (S3-совместимое)             |
| **Префикс API** | `/api/v1/duties`                   |
| **Версия API**  | 1.0.0                              |

---

## Функциональность

### Управление расписанием дежурств

#### Создание расписания

Старостой или воспитателем назначается расписание дежурства:

- **Входные данные**: ID комнаты, дата дежурства
- **Процесс**: Система создаёт запись о дежурстве со статусом `pending`
- **Уведомление**: Автоматическое напоминание студентам за 1 день до дежурства
- **Валидация**: Предотвращение дублирования дежурств (одна комната — одно дежурство на дату)

#### Статусы дежурства

| Статус    | Описание                                          |
| --------- | ------------------------------------------------- |
| `pending` | Дежурство назначено, ожидает начала               |
| `active`  | Дежурство активно (начато, ожидается отчёт)      |
| `accepted`| Фотоотчёт одобрен, дежурство выполнено           |
| `overdue` | Фотоотчёт не загружен до 23:00 — нарушение       |

#### REST API для расписаний

- **GET** `/duties/schedules` — получить список расписаний с пагинацией и фильтрацией
- **POST** `/duties/schedules` — создать новое расписание
- **GET** `/duties/schedules/{scheduleId}` — получить расписание
- **PUT** `/duties/schedules/{scheduleId}` — полное обновление расписания
- **PATCH** `/duties/schedules/{scheduleId}` — обновление статуса
- **DELETE** `/duties/schedules/{scheduleId}` — удалить расписание

### Управление фотоотчётами

#### Загрузка отчётов

Студент загружает фотоотчёт после выполнения дежурства:

- **Статус**: Устанавливается `submitted`

#### Проверка отчётов

Воспитатель проверяет и одобряет/отклоняет отчёт:

- **Одобрение**: Статус меняется на `accepted`
- **Отклонение**: Статус меняется на `rejected` с указанием причины
- **Переготовка**: Студент может загрузить исправленный отчёт

#### REST API для отчётов

- **GET** `/duties/reports` — получить список отчётов с пагинацией
- **POST** `/duties/reports` — создать новый отчёт
- **GET** `/duties/reports/{reportId}` — получить отчёт с фотографиями
- **PUT** `/duties/reports/{reportId}` — полное обновление отчёта
- **PATCH** `/duties/reports/{reportId}` — изменение статуса
- **DELETE** `/duties/reports/{reportId}` — удалить отчёт

### Управление фотографиями в отчётах

#### Загрузка фотографий

- Фотография привязывается к отчёту и категории
- Хранение в MinIO с генерацией URL
- Валидация формата и размера

#### Категоризация

- **Кухня** — состояние кухонных помещений
- **Коридор** — состояние коридоров и лестничных клеток
- **Санузлы** — состояние ванных комнат и туалетов
- **Постирочная** — состояние постирочных помещений
- **Коворкинг** — состояние учебных пространств
- И другие (настраиваются администраторами)

#### REST API для фотографий

- **GET** `/duties/reports/{reportId}/images` — получить фотографии отчёта
- **POST** `/duties/reports/{reportId}/images` — загрузить фотографию
- **GET** `/duties/reports/images/{imageId}` — получить фотографию
- **DELETE** `/duties/reports/images/{imageId}` — удалить фотографию

### Управление категориями

#### Создание категорий

Администраторы могут создавать новые категории для специфичных помещений или зон.

#### REST API для категорий

- **GET** `/duties/categories` — получить список категорий
- **POST** `/duties/categories` — создать новую категорию
- **GET** `/duties/categories/{categoryId}` — получить категорию
- **DELETE** `/duties/categories/{categoryId}` — удалить категорию

---

## Модель данных

### Таблица `duty_schedules`

Расписание дежурств — привязка комнаты к дате дежурства (дежурства назначаются старостой/воспитателем).

| Столбец       | Тип                        | Nullable | Описание                                        |
| ------------- | -------------------------- | -------- | ----------------------------------------------- |
| `id`          | `UUID`                     | NO       | PK. Идентификатор записи расписания             |
| `room_id`     | `UUID`                     | NO       | ID комнаты из auth-service                      |
| `duty_date`   | `DATE`                     | NO       | Дата дежурства                                  |
| `assigned_by` | `UUID`                     | NO       | UUID старосты или воспитателя, назначившего     |
| `status`      | `VARCHAR(20)`              | NO       | Статус: `pending`, `active`, `accepted`, `overdue` |
| `created_at`  | `TIMESTAMP WITH TIME ZONE` | NO       | Дата создания записи (UTC)                      |
| `updated_at`  | `TIMESTAMP WITH TIME ZONE` | NO       | Дата последнего обновления (UTC)                |

**Индексы**:
- PK: `id`
- Unique: `(room_id, duty_date)`
- Index: `duty_date`, `status`, `assigned_by`

### Таблица `duty_reports`

Отчёты по дежурству (его оставляет какой-то студент). У одного дежурства может быть несколько отчётов, каждый - принят или нет. Patch (статус), put, delete

| Столбец        | Тип                        | Nullable | Описание                                  |
| -------------- | -------------------------- | -------- | ----------------------------------------- |
| `id`           | `UUID`                     | NO       | PK. Идентификатор отчёта                  |
| `schedule_id`  | `UUID`                     | NO       | FK → `duty_schedules.id`                  |
| `user_id`      | `UUID`                     | NO       | ID студента из auth-service               |
| `status`       | `VARCHAR(20)`              | NO       | Статус: `submitted`, `accepted`, `rejected` |
| `created_at`   | `TIMESTAMP WITH TIME ZONE` | NO       | Дата создания отчёта (UTC)                |
| `updated_at`   | `TIMESTAMP WITH TIME ZONE` | NO       | Дата последнего обновления (UTC)          |
| `reviewed_by`  | `UUID`                     | YES      | UUID проверяющего (воспитателя)           |
| `reviewed_at`  | `TIMESTAMP WITH TIME ZONE` | YES      | Время проверки отчёта (UTC)               |
| `reject_reason`| `TEXT`                     | YES      | Причина отклонения (при `rejected`)       |

**Индексы**:
- PK: `id`
- FK: `schedule_id`, `user_id`, `reviewed_by`
- Index: `status`, `created_at`

### Таблица `duty_report_images`

Фотографии, приложенные к отчёту (можно назначить каждому фото категорию)

| Столбец      | Тип                        | Nullable | Описание                                      |
| ------------ | -------------------------- | -------- | --------------------------------------------- |
| `id`         | `UUID`                     | NO       | PK. Идентификатор фотографии                  |
| `report_id`  | `UUID`                     | NO       | FK → `duty_reports.id`. Привязка к отчёту     |
| `category_id`| `UUID`                     | NO       | FK → `duty_report_categories.id`              |
| `photo_url`  | `VARCHAR(500)`             | NO       | URL фотографии в хранилище (MinIO)            |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | NO       | Дата создания записи (UTC)                    |
| `updated_at` | `TIMESTAMP WITH TIME ZONE` | NO       | Дата последнего обновления (UTC)              |

**Индексы**:
- PK: `id`
- FK: `report_id`, `category_id`
- Index: `report_id`

### Таблица `duty_report_categories`

Все категории для фото в отчёте. Delete должен быть

| Столбец | Тип                  | Nullable | Описание                                  |
| ------- | -------------------- | -------- | ----------------------------------------- |
| `id`    | `UUID`               | NO       | PK. Идентификатор категории               |
| `name`  | `VARCHAR(50)`        | NO       | Имя категории (уникальное)                |

**Индексы**:
- PK: `id`
- Unique: `name`

---

## API-контракты

### Формат даты и времени

- **Дата** (без времени): `2025-12-01` (ISO 8601, YYYY-MM-DD)
- **Дата-время**: `2025-12-01T20:15:00Z` (ISO 8601, UTC)
- **Хранение в БД**: UTC, `TIMESTAMP WITH TIME ZONE`

### Пагинация

Все списки поддерживают пагинацию через query-параметры:

```
GET /api/v1/duties/schedules?page=1&size=20
```

| Параметр | Тип | По умолчанию | Описание                |
| -------- | --- | ------------ | ----------------------- |
| `page`   | int | 1            | Номер страницы (от 1)   |
| `size`   | int | 20           | Кол-во элементов (≤100) |

**Ответ с пагинацией**:

```json
{
  "items": [...],
  "total": 48,
  "page": 1,
  "size": 20,
  "pages": 3
}
```

### Фильтрация

**Расписание дежурств**:

```
GET /api/v1/duties/schedules?room_id=<uuid>&duty_date_from=2025-12-01&duty_date_to=2025-12-31&status=pending
```

**Отчёты**:

```
GET /api/v1/duties/reports?schedule_id=<uuid>&user_id=<uuid>&status=submitted
```

### Обработка ошибок

**Формат ошибки**:

```json
{
  "error": {
    "code": "DUTY_NOT_FOUND",
    "message": "Дежурство с указанным ID не найдено.",
    "trace_id": "550e8400-e29b-41d4-a716-446655440000",
    "details": null
  }
}
```

**Коды ошибок с префиксом DUTY_**:

| Код                      | HTTP | Описание                              |
| ------------------------ | ---- | ------------------------------------- |
| `DUTY_NOT_FOUND`         | 404  | Расписание не найдено                 |
| `DUTY_ALREADY_ASSIGNED`  | 409  | Дежурство уже назначено на эту дату   |
| `DUTY_REPORT_NOT_FOUND`  | 404  | Отчёт не найден                       |
| `DUTY_CATEGORY_NOT_FOUND`| 404  | Категория не найдена                  |
| `DUTY_INVALID_STATUS`    | 400  | Недопустимый статус                   |
| `VALIDATION_ERROR`       | 400  | Ошибка валидации входных данных       |
| `UNAUTHORIZED`           | 401  | Требуется авторизация                 |
| `FORBIDDEN`              | 403  | Недостаточно прав доступа             |
| `INTERNAL_ERROR`         | 500  | Внутренняя ошибка сервера             |

### HTTP-статусы

| Код | Использование                          |
| --- | --------------------------------------- |
| 200 | Успешный запрос (GET, PUT, PATCH)       |
| 201 | Ресурс создан (POST)                    |
| 204 | Успешно, без тела ответа (DELETE)       |
| 400 | Ошибка валидации                        |
| 401 | Не аутентифицирован                     |
| 403 | Нет прав доступа                        |
| 404 | Ресурс не найден                        |
| 409 | Конфликт (дублирование)                 |
| 422 | Ошибка валидации (FastAPI)              |
| 500 | Внутренняя ошибка сервера               |

---

\* Студент видит только свои отчёты и отчёты своей комнаты

### Жизненный цикл дежурства

```
pending (назначено)
    ↓
active (начато, ожидается отчёт)
    ↓
┌─────────────────────┐
│  Отчёт загружен?    │
└─────────────────────┘
    ↙ Да                ↘ Нет (23:00)
    ↓                    ↓
 accepted/rejected     overdue
 (одобрено/отклонено)            (нарушение)
```

---

## Взаимодействие с другими сервисами

### auth-service (gRPC)

**Используется для**:
- Валидации JWT-токенов
- Получения информации о студентах, их комнатах и подъездах
- Проверки ролей пользователей (старост, воспитателей)

**Протокол**: gRPC

