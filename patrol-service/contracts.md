# Контракты patrol-service

## Предоставляемые контракты (REST API)

Базовый URL: `http://localhost:8002/api/v1`

| Метод  | Путь                                    | Описание                                      |
|--------|-----------------------------------------|-----------------------------------------------|
| GET    | /patrols                                | Список обходов с пагинацией и фильтрацией     |
| POST   | /patrols                                | Создать новый сеанс обхода                    |
| GET    | /patrols/{patrolId}                     | Получить полное состояние обхода              |
| PATCH  | /patrols/{patrolId}                     | Частично обновить состояние обхода            |
| DELETE | /patrols/{patrolId}                     | Удалить сеанс обхода                          |
| GET    | /patrols/{patrolId}/{patrolEntryId}     | Получить запись проверки студента             |
| PATCH  | /patrols/{patrolId}/{patrolEntryId}     | Частично обновить запись проверки студента    |

Полная спецификация — `openapi.yaml`.

## Потребляемые контракты (gRPC)

### auth-service (порт 50051)

Пакет: `campus.auth`

| RPC           | Запрос             | Ответ               | Когда используется                                         |
|---------------|--------------------|---------------------|------------------------------------------------------------|
| ValidateToken | ValidateTokenRequest | ValidateTokenResponse | Валидация JWT при каждом входящем REST-запросе           |
| GetUsers      | GetUsersRequest    | GetUsersResponse    | При создании обхода — получение несовершеннолетних студентов подъезда |

**GetUsersRequest** (используемые поля):

| Поле     | Тип    | Значение                        |
|----------|--------|---------------------------------|
| building | string | Корпус из запроса на создание   |
| entrance | int32  | Подъезд из запроса на создание  |
| role     | string | `"student"`                     |

Сервис фильтрует по `is_minor = true` на стороне auth-service через поле `role` или на стороне patrol-service по полю `is_minor` из `UserInfoResponse`.

### application-service (порт 50055)

Пакет: `campus.application`

| RPC                | Запрос                    | Ответ                      | Когда используется                                               |
|--------------------|---------------------------|----------------------------|------------------------------------------------------------------|
| GetApprovedLeaves  | GetApprovedLeavesRequest  | GetApprovedLeavesResponse  | При создании обхода — получение одобренных заявлений на выход   |

**GetApprovedLeavesRequest** (используемые поля):

| Поле     | Тип    | Значение                       |
|----------|--------|--------------------------------|
| date     | string | Дата обхода (YYYY-MM-DD)       |
| building | string | Корпус из запроса на создание  |
| entrance | int32  | Подъезд из запроса на создание |

## Коды ошибок patrol-service

| Код                      | HTTP | Описание                                              |
|--------------------------|------|-------------------------------------------------------|
| PATROL_NOT_FOUND         | 404  | Обход с указанным ID не найден                        |
| PATROL_ENTRY_NOT_FOUND   | 404  | Запись проверки студента не найдена в данном обходе   |
| PATROL_ALREADY_EXISTS    | 409  | Обход для данного подъезда на эту дату уже существует |
| PATROL_ALREADY_COMPLETED | 422  | Обход уже завершён, повторное завершение невозможно   |
| PATROL_NOT_IN_PROGRESS   | 422  | Обход не в статусе in_progress, обновление невозможно |
| VALIDATION_ERROR         | 400  | Ошибка валидации входных данных                       |
| UNAUTHORIZED             | 401  | Токен отсутствует или невалиден                       |
| FORBIDDEN                | 403  | Недостаточно прав                                     |
| INTERNAL_ERROR           | 500  | Внутренняя ошибка сервера                             |