# Проектирование БД application-service (3НФ)

База данных: **application_db** (PostgreSQL 15+). Каждый микросервис владеет своей БД; прямые запросы в БД других сервисов запрещены (ТЗ-0, README).

---

## 1. Цель и нормальная форма

Схема приведена к **третьей нормальной форме (3НФ)**:

- Нет повторяющихся групп (1НФ).
- Все неключевые атрибуты зависят от полного первичного ключа (2НФ).
- Нет транзитивных зависимостей: неключевые атрибуты зависят только от первичного ключа (3НФ).

Данные о пользователе (ФИО, комната, подъезд, корпус) **не дублируются** в application-service — они запрашиваются по `user_id` через gRPC у auth-service. В таблице `applications` хранится только ссылка `user_id` и данные, относящиеся непосредственно к заявлению.

---

## 2. Таблица `applications`

Одна запись — одно заявление на выход из кампуса.

| Столбец | Тип | Nullable | Описание |
|---------|-----|----------|----------|
| id | UUID | NO | PK. Идентификатор заявления |
| user_id | UUID | NO | UUID студента-заявителя (внешняя ссылка на auth.users, не FK в другой БД) |
| is_minor | BOOLEAN | NO | Несовершеннолетний ли заявитель (на момент подачи; для бизнес-правил) |
| leave_time | TIMESTAMP WITH TIME ZONE | NO | Планируемое время выхода (UTC) |
| return_time | TIMESTAMP WITH TIME ZONE | NO | Планируемое время возврата (UTC) |
| reason | TEXT | NO | Цель выхода / причина отсутствия |
| contact_phone | VARCHAR(20) | NO | Контактный телефон (BR-EXIT-002) |
| status | VARCHAR(20) | NO | Статус: `pending`, `approved`, `rejected` |
| decided_by | UUID | YES | UUID воспитателя, принявшего решение |
| decided_at | TIMESTAMP WITH TIME ZONE | YES | Время принятия решения |
| reject_reason | TEXT | YES | Причина отклонения (при status=rejected) |
| created_at | TIMESTAMP WITH TIME ZONE | NO | Дата создания записи |
| updated_at | TIMESTAMP WITH TIME ZONE | NO | Дата последнего обновления |

**Обоснование 3НФ:** все атрибуты зависят только от `id`. `user_id` — ссылка на внешнюю систему; ФИО, комната, подъезд, корпус не хранятся здесь, чтобы избежать дублирования и рассинхронизации (Database per Service).

**Опциональный снимок (snapshot):** для отчётов и истории при необходимости можно добавить поля-снимок на момент подачи: `snapshot_room`, `snapshot_entrance`, `snapshot_building`, `snapshot_user_name`. Это денормализация для производительности отчётов; в текущем MVP достаточно получать данные по gRPC GetUserInfo при отображении. Решение о введении снимка можно принять при появлении требований к офлайн-отчётам или при высокой нагрузке на auth-service.

---

## 3. Таблица `application_documents`

Документы, прикреплённые к заявлению (скан заявления, письмо родителя, голосовое сообщение).

| Столбец | Тип | Nullable | Описание |
|---------|-----|----------|----------|
| id | UUID | NO | PK. Идентификатор документа |
| application_id | UUID | NO | FK → applications.id. Привязка к заявлению |
| document_type | VARCHAR(30) | NO | Тип документа (см. перечень ниже) |
| file_url | VARCHAR(500) | NO | URL/ключ файла в хранилище (MinIO) |
| uploaded_by | UUID | NO | UUID пользователя, загрузившего документ |
| created_at | TIMESTAMP WITH TIME ZONE | NO | Дата создания записи |
| updated_at | TIMESTAMP WITH TIME ZONE | NO | Дата последнего обновления |

**Допустимые значения `document_type`:**

| Значение | Описание |
|----------|----------|
| signed_application | Сканированное/сфотографированное подписанное заявление (PDF, JPG, PNG) |
| parent_letter | Заявление от родителя для несовершеннолетних (PDF, JPG, PNG) |
| voice_message | Голосовое сообщение от родителя (MP3, M4A, WAV; макс. 2 минуты) |

**Обоснование 3НФ:** одна таблица документов; тип задаётся значением enum/константы. Все атрибуты зависят от `id`; `application_id` — внешний ключ в пределах той же БД.

---

## 4. Ограничения и бизнес-правила

- **Несовершеннолетние (BR-EXIT-003, BR-EXIT-004):** для заявления с `is_minor = true` обязательно наличие хотя бы одного документа с `document_type = 'voice_message'`. Проверка выполняется в application-слое (сервис) при подаче/перед одобрением.
- **Уникальность:** по бизнес-правилам можно допускать несколько заявлений от одного студента с разными датами; уникальный ключ по (user_id, leave_time) не вводим без явного требования.
- **Статус:** только переходы pending → approved или pending → rejected; повторное изменение статуса не допускается (проверка в сервисе).

---

## 5. Индексы

| Таблица | Индекс | Назначение |
|---------|--------|------------|
| applications | (user_id) | Список заявлений студента |
| applications | (status) | Фильтр по статусу для воспитателя |
| applications | (leave_time) | Фильтр по дате, gRPC GetApprovedLeaves |
| applications | (status, leave_time) | Комбинированный запрос одобренных на дату |
| application_documents | (application_id) | Выборка документов по заявлению |

Первичные ключи (id) индексируются автоматически.

---

## 6. Общие соглашения (ТЗ-1)

- Первичные ключи — UUID.
- Во всех таблицах: `created_at`, `updated_at` — TIMESTAMP WITH TIME ZONE (UTC).
- Именование: таблицы и столбцы в `snake_case`.
- ORM: SQLAlchemy 2.0+ (Mapped, mapped_column), миграции — Alembic.
